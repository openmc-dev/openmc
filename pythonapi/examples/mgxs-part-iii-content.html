<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Generate Input Files &mdash; OpenMC Documentation</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="OpenMC Documentation" href="../../index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner">
        <a href="../../index.html">
          <img class="logo" src="../../_static/openmc.png" alt="Logo"/>
        </a>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <p>This IPython Notebook illustrates the use of the
<strong>``openmc.mgxs.Library``</strong> class. The <code class="docutils literal"><span class="pre">Library</span></code> class is designed to
automate the calculation of multi-group cross sections for use cases
with one or more domains, cross section types, and/or nuclides. In
particular, this Notebook illustrates the following features:</p>
<ul class="simple">
<li>Calculation of multi-group cross sections for a <strong>fuel assembly</strong></li>
<li>Automated creation, manipulation and storage of <code class="docutils literal"><span class="pre">MGXS</span></code> with
<strong>``openmc.mgxs.Library``</strong></li>
<li><strong>Validation</strong> of multi-group cross sections with
<strong>`OpenMOC &lt;https://mit-crpg.github.io/OpenMOC/&gt;`__</strong></li>
<li>Steady-state pin-by-pin <strong>fission rates comparison</strong> between OpenMC
and <a class="reference external" href="https://mit-crpg.github.io/OpenMOC/">OpenMOC</a></li>
</ul>
<p><strong>Note:</strong> This Notebook was created using
<a class="reference external" href="https://mit-crpg.github.io/OpenMOC/">OpenMOC</a> to verify the
multi-group cross-sections generated by OpenMC. In order to run this
Notebook in its entirety, you must have
<a class="reference external" href="https://mit-crpg.github.io/OpenMOC/">OpenMOC</a> installed on your
system, along with OpenCG to convert the OpenMC geometries into OpenMOC
geometries. In addition, this Notebook illustrates the use of
<a class="reference external" href="http://pandas.pydata.org/">Pandas</a> <code class="docutils literal"><span class="pre">DataFrames</span></code> to containerize
multi-group cross section data. We recommend using
<a class="reference external" href="http://pandas.pydata.org/">Pandas</a> &gt;v0.15.0 or later since OpenMC&#8217;s
Python API leverages the multi-indexing feature included in the most
recent releases of <a class="reference external" href="http://pandas.pydata.org/">Pandas</a>.</p>
<div class="section" id="generate-input-files">
<h1>Generate Input Files<a class="headerlink" href="#generate-input-files" title="Permalink to this headline">¶</a></h1>
<div class="code python highlight-python"><div class="highlight"><pre>import math
import pickle
from IPython.display import Image
import matplotlib.pylab as pylab
import numpy as np

import openmc
import openmc.mgxs
from openmc.statepoint import StatePoint
from openmc.summary import Summary

import openmoc
import openmoc.process
from openmoc.compatible import get_openmoc_geometry
from openmoc.materialize import load_openmc_mgxs_lib

%matplotlib inline
</pre></div>
</div>
<pre class="literal-block">
/usr/lib/pymodules/python2.7/matplotlib/__init__.py:1173: UserWarning:  This call to matplotlib.use() has no effect
because the backend has already been chosen;
matplotlib.use() must be called <em>before</em> pylab, matplotlib.pyplot,
or matplotlib.backends is imported for the first time.

  warnings.warn(_use_error_msg)
</pre>
<p>First we need to define materials that will be used in the problem.
Before defining a material, we must create nuclides that are used in the
material.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate some Nuclides</span>
<span class="n">h1</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;H-1&#39;</span><span class="p">)</span>
<span class="n">b10</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;B-10&#39;</span><span class="p">)</span>
<span class="n">o16</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;O-16&#39;</span><span class="p">)</span>
<span class="n">u235</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;U-235&#39;</span><span class="p">)</span>
<span class="n">u238</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;U-238&#39;</span><span class="p">)</span>
<span class="n">zr90</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Nuclide</span><span class="p">(</span><span class="s">&#39;Zr-90&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>With the nuclides we defined, we will now create three materials for the
fuel, water, and cladding of the fuel pins.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># 1.6 enriched fuel</span>
<span class="n">fuel</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel&#39;</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">10.31341</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u235</span><span class="p">,</span> <span class="mf">3.7503e-4</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">u238</span><span class="p">,</span> <span class="mf">2.2625e-2</span><span class="p">)</span>
<span class="n">fuel</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">o16</span><span class="p">,</span> <span class="mf">4.6007e-2</span><span class="p">)</span>

<span class="c"># borated water</span>
<span class="n">water</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Borated Water&#39;</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">0.740582</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">h1</span><span class="p">,</span> <span class="mf">4.9457e-2</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">o16</span><span class="p">,</span> <span class="mf">2.4732e-2</span><span class="p">)</span>
<span class="n">water</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">b10</span><span class="p">,</span> <span class="mf">8.0042e-6</span><span class="p">)</span>

<span class="c"># zircaloy</span>
<span class="n">zircaloy</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Material</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Zircaloy&#39;</span><span class="p">)</span>
<span class="n">zircaloy</span><span class="o">.</span><span class="n">set_density</span><span class="p">(</span><span class="s">&#39;g/cm3&#39;</span><span class="p">,</span> <span class="mf">6.55</span><span class="p">)</span>
<span class="n">zircaloy</span><span class="o">.</span><span class="n">add_nuclide</span><span class="p">(</span><span class="n">zr90</span><span class="p">,</span> <span class="mf">7.2758e-3</span><span class="p">)</span>
</pre></div>
</div>
<p>With our three materials, we can now create a <code class="docutils literal"><span class="pre">MaterialsFile</span></code> object
that can be exported to an actual XML file.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a MaterialsFile, add Materials</span>
<span class="n">materials_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">MaterialsFile</span><span class="p">()</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">fuel</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">water</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">add_material</span><span class="p">(</span><span class="n">zircaloy</span><span class="p">)</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">default_xs</span> <span class="o">=</span> <span class="s">&#39;71c&#39;</span>

<span class="c"># Export to &quot;materials.xml&quot;</span>
<span class="n">materials_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>Now let&#8217;s move on to the geometry. This problem will be a square array
of fuel pins and control rod guide tubes for which we can use OpenMC&#8217;s
lattice/universe feature. The basic universe will have three regions for
the fuel, the clad, and the surrounding coolant. The first step is to
create the bounding surfaces for fuel and clad, as well as the outer
bounding surfaces of the problem.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create cylinders for the fuel and clad</span>
<span class="n">fuel_outer_radius</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZCylinder</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.39218</span><span class="p">)</span>
<span class="n">clad_outer_radius</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZCylinder</span><span class="p">(</span><span class="n">x0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mf">0.45720</span><span class="p">)</span>

<span class="c"># Create boundary planes to surround the geometry</span>
<span class="n">min_x</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">XPlane</span><span class="p">(</span><span class="n">x0</span><span class="o">=-</span><span class="mf">10.71</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_x</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">XPlane</span><span class="p">(</span><span class="n">x0</span><span class="o">=+</span><span class="mf">10.71</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">min_y</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">YPlane</span><span class="p">(</span><span class="n">y0</span><span class="o">=-</span><span class="mf">10.71</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_y</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">YPlane</span><span class="p">(</span><span class="n">y0</span><span class="o">=+</span><span class="mf">10.71</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">min_z</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZPlane</span><span class="p">(</span><span class="n">z0</span><span class="o">=-</span><span class="mf">10.</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
<span class="n">max_z</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">ZPlane</span><span class="p">(</span><span class="n">z0</span><span class="o">=+</span><span class="mf">10.</span><span class="p">,</span> <span class="n">boundary_type</span><span class="o">=</span><span class="s">&#39;reflective&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>With the surfaces defined, we can now construct a fuel pin cell from
cells that are defined by intersections of half-spaces created by the
surfaces.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create a Universe to encapsulate a fuel pin</span>
<span class="n">fuel_pin_universe</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel Pin&#39;</span><span class="p">)</span>

<span class="c"># Create fuel Cell</span>
<span class="n">fuel_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel&#39;</span><span class="p">)</span>
<span class="n">fuel_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">fuel</span>
<span class="n">fuel_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">-</span><span class="n">fuel_outer_radius</span>
<span class="n">fuel_pin_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">fuel_cell</span><span class="p">)</span>

<span class="c"># Create a clad Cell</span>
<span class="n">clad_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6% Clad&#39;</span><span class="p">)</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">zircaloy</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">fuel_outer_radius</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">clad_outer_radius</span>
<span class="n">fuel_pin_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">clad_cell</span><span class="p">)</span>

<span class="c"># Create a moderator Cell</span>
<span class="n">moderator_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6% Moderator&#39;</span><span class="p">)</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">water</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">clad_outer_radius</span>
<span class="n">fuel_pin_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">moderator_cell</span><span class="p">)</span>
</pre></div>
</div>
<p>Likewise, we can construct a control rod guide tube with the same
surfaces.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create a Universe to encapsulate a control rod guide tube</span>
<span class="n">guide_tube_universe</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Guide Tube&#39;</span><span class="p">)</span>

<span class="c"># Create guide tube Cell</span>
<span class="n">guide_tube_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Guide Tube Water&#39;</span><span class="p">)</span>
<span class="n">guide_tube_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">water</span>
<span class="n">guide_tube_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">-</span><span class="n">fuel_outer_radius</span>
<span class="n">guide_tube_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">guide_tube_cell</span><span class="p">)</span>

<span class="c"># Create a clad Cell</span>
<span class="n">clad_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Guide Clad&#39;</span><span class="p">)</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">zircaloy</span>
<span class="n">clad_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">fuel_outer_radius</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">clad_outer_radius</span>
<span class="n">guide_tube_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">clad_cell</span><span class="p">)</span>

<span class="c"># Create a moderator Cell</span>
<span class="n">moderator_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Guide Tube Moderator&#39;</span><span class="p">)</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">water</span>
<span class="n">moderator_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">clad_outer_radius</span>
<span class="n">guide_tube_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">moderator_cell</span><span class="p">)</span>
</pre></div>
</div>
<p>Using the pin cell universe, we can construct a 17x17 rectangular
lattice with a 1.26 cm pitch.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create fuel assembly Lattice</span>
<span class="n">assembly</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">RectLattice</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;1.6</span><span class="si">% F</span><span class="s">uel Assembly&#39;</span><span class="p">)</span>
<span class="n">assembly</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">)</span>
<span class="n">assembly</span><span class="o">.</span><span class="n">pitch</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.26</span><span class="p">,</span> <span class="mf">1.26</span><span class="p">)</span>
<span class="n">assembly</span><span class="o">.</span><span class="n">lower_left</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.26</span> <span class="o">*</span> <span class="mf">17.</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Next, we create a NumPy array of fuel pin and guide tube universes for
the lattice.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create array indices for guide tube locations in lattice</span>
<span class="n">template_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
                       <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">])</span>
<span class="n">template_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
                       <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">])</span>

<span class="c"># Initialize an empty 17x17 array of the lattice universes</span>
<span class="n">universes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">)</span>

<span class="c"># Fill the array with the fuel pin and guide tube universes</span>
<span class="n">universes</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="n">fuel_pin_universe</span>
<span class="n">universes</span><span class="p">[</span><span class="n">template_x</span><span class="p">,</span> <span class="n">template_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">guide_tube_universe</span>

<span class="c"># Store the array of universes in the lattice</span>
<span class="n">assembly</span><span class="o">.</span><span class="n">universes</span> <span class="o">=</span> <span class="n">universes</span>
</pre></div>
</div>
<p>OpenMC requires that there is a &#8220;root&#8221; universe. Let us create a root
cell that is filled by the pin cell universe and then assign it to the
root universe.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create root Cell</span>
<span class="n">root_cell</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Cell</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;root cell&#39;</span><span class="p">)</span>
<span class="n">root_cell</span><span class="o">.</span><span class="n">fill</span> <span class="o">=</span> <span class="n">assembly</span>

<span class="c"># Add boundary planes</span>
<span class="n">root_cell</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="o">+</span><span class="n">min_x</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_x</span> <span class="o">&amp;</span> <span class="o">+</span><span class="n">min_y</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_y</span> <span class="o">&amp;</span> <span class="o">+</span><span class="n">min_z</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">max_z</span>

<span class="c"># Create root Universe</span>
<span class="n">root_universe</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Universe</span><span class="p">(</span><span class="n">universe_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;root universe&#39;</span><span class="p">)</span>
<span class="n">root_universe</span><span class="o">.</span><span class="n">add_cell</span><span class="p">(</span><span class="n">root_cell</span><span class="p">)</span>
</pre></div>
</div>
<p>We now must create a geometry that is assigned a root universe, put the
geometry into a <code class="docutils literal"><span class="pre">GeometryFile</span></code> object, and export it to XML.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create Geometry and set root Universe</span>
<span class="n">geometry</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Geometry</span><span class="p">()</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">root_universe</span> <span class="o">=</span> <span class="n">root_universe</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a GeometryFile</span>
<span class="n">geometry_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">GeometryFile</span><span class="p">()</span>
<span class="n">geometry_file</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>

<span class="c"># Export to &quot;geometry.xml&quot;</span>
<span class="n">geometry_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>With the geometry and materials finished, we now just need to define
simulation parameters. In this case, we will use 10 inactive batches and
40 active batches each with 2500 particles.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># OpenMC simulation parameters</span>
<span class="n">batches</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">inactive</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">particles</span> <span class="o">=</span> <span class="mi">2500</span>

<span class="c"># Instantiate a SettingsFile</span>
<span class="n">settings_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">SettingsFile</span><span class="p">()</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">batches</span> <span class="o">=</span> <span class="n">batches</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">inactive</span> <span class="o">=</span> <span class="n">inactive</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;tallies&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;summary&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
<span class="n">source_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">10.71</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.71</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mf">10.71</span><span class="p">,</span> <span class="mf">10.71</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">set_source_space</span><span class="p">(</span><span class="s">&#39;fission&#39;</span><span class="p">,</span> <span class="n">source_bounds</span><span class="p">)</span>

<span class="c"># Export to &quot;settings.xml&quot;</span>
<span class="n">settings_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>Let us also create a <code class="docutils literal"><span class="pre">PlotsFile</span></code> that we can use to verify that our
fuel assembly geometry was created successfully.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a Plot</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plot_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&#39;materials-xy&#39;</span>
<span class="n">plot</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">[</span><span class="mf">21.5</span><span class="p">,</span> <span class="mf">21.5</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">pixels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span>
<span class="n">plot</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="s">&#39;mat&#39;</span>

<span class="c"># Instantiate a PlotsFile, add Plot, and export to &quot;plots.xml&quot;</span>
<span class="n">plot_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">PlotsFile</span><span class="p">()</span>
<span class="n">plot_file</span><span class="o">.</span><span class="n">add_plot</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
<span class="n">plot_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<p>With the plots.xml file, we can now generate and view the plot. OpenMC
outputs plots in .ppm format, which can be converted into a compressed
format like .png with the convert utility.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Run openmc in plotting mode</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Executor</span><span class="p">()</span>
<span class="n">executor</span><span class="o">.</span><span class="n">plot_geometry</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre># Convert OpenMC&#39;s funky ppm to png
!convert materials-xy.ppm materials-xy.png

# Display the materials plot inline
Image(filename=&#39;materials-xy.png&#39;)
</pre></div>
</div>
<img alt="../../_images/mgxs-part-iii-content_30_0.png" src="../../_images/mgxs-part-iii-content_30_0.png" />
<p>As we can see from the plot, we have a nice array of fuel and guide tube
pin cells with fuel, cladding, and water!</p>
</div>
<div class="section" id="create-an-mgxs-library">
<h1>Create an MGXS Library<a class="headerlink" href="#create-an-mgxs-library" title="Permalink to this headline">¶</a></h1>
<p>Now we are ready to generate multi-group cross sections! First, let&#8217;s
define a 2-group structure using the built-in <code class="docutils literal"><span class="pre">EnergyGroups</span></code> class.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a 2-group EnergyGroups object</span>
<span class="n">groups</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">mgxs</span><span class="o">.</span><span class="n">EnergyGroups</span><span class="p">()</span>
<span class="n">groups</span><span class="o">.</span><span class="n">group_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.625e-6</span><span class="p">,</span> <span class="mf">20.</span><span class="p">])</span>
</pre></div>
</div>
<p>Next, we will instantiate an <code class="docutils literal"><span class="pre">openmc.mgxs.Library</span></code> for the energy
groups with our the fuel assembly geometry.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Initialize an 2-group MGXS Library for OpenMOC</span>
<span class="n">mgxs_lib</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">mgxs</span><span class="o">.</span><span class="n">Library</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">energy_groups</span> <span class="o">=</span> <span class="n">groups</span>
</pre></div>
</div>
<p>Now, we must specify to the <code class="docutils literal"><span class="pre">Library</span></code> which types of cross sections to
compute. In particular, the following are the multi-group cross section
<code class="docutils literal"><span class="pre">MGXS</span></code> subclasses that are mapped to string codes accepted by the
<code class="docutils literal"><span class="pre">Library</span></code> class:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">TotalXS</span></code> (<code class="docutils literal"><span class="pre">&quot;total&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">TransportXS</span></code> (<code class="docutils literal"><span class="pre">&quot;transport&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">AbsorptionXS</span></code> (<code class="docutils literal"><span class="pre">&quot;absorption&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">CaptureXS</span></code> (<code class="docutils literal"><span class="pre">&quot;capture&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">FissionXS</span></code> (<code class="docutils literal"><span class="pre">&quot;fission&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">NuFissionXS</span></code> (<code class="docutils literal"><span class="pre">&quot;nu-fission&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">ScatterXS</span></code> (<code class="docutils literal"><span class="pre">&quot;scatter&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">NuScatterXS</span></code> (<code class="docutils literal"><span class="pre">&quot;nu-scatter&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">ScatterMatrixXS</span></code> (<code class="docutils literal"><span class="pre">&quot;scatter</span> <span class="pre">matrix&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">NuScatterMatrixXS</span></code> (<code class="docutils literal"><span class="pre">&quot;nu-scatter</span> <span class="pre">matrix&quot;</span></code>)</li>
<li><code class="docutils literal"><span class="pre">Chi</span></code> (<code class="docutils literal"><span class="pre">&quot;chi&quot;</span></code>)</li>
</ul>
<p>In this case, let&#8217;s create the multi-group cross sections needed to run
an OpenMOC simulation to verify the accuracy of our cross sections. In
particular, we will define <code class="docutils literal"><span class="pre">&quot;transport&quot;</span></code>, <code class="docutils literal"><span class="pre">&quot;nu-fission&quot;</span></code>,
<code class="docutils literal"><span class="pre">&quot;nu-scatter</span> <span class="pre">matrix&quot;</span></code> and <code class="docutils literal"><span class="pre">&quot;chi&quot;</span></code> cross sections for our
<code class="docutils literal"><span class="pre">Library</span></code>.</p>
<p><strong>Note</strong>: A variety of different approximate transport-corrected total
multi-group cross sections (and corresponding scattering matrices) can
be found in the literature. At the present time, the <code class="docutils literal"><span class="pre">openmc.mgxs</span></code>
module only supports the <code class="docutils literal"><span class="pre">&quot;P0&quot;</span></code> transport correction. This correction
can be turned on and off through the boolean <code class="docutils literal"><span class="pre">Library.correction</span></code>
property which may take values of <code class="docutils literal"><span class="pre">&quot;P0&quot;</span></code> (default) or <code class="docutils literal"><span class="pre">None</span></code>.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Specify multi-group cross section types to compute</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">mgxs_types</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;transport&#39;</span><span class="p">,</span> <span class="s">&#39;nu-fission&#39;</span><span class="p">,</span> <span class="s">&#39;nu-scatter matrix&#39;</span><span class="p">,</span> <span class="s">&#39;chi&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now we must specify the type of domain over which we would like the
<code class="docutils literal"><span class="pre">Library</span></code> to compute multi-group cross sections. The domain type
corresponds to the type of tally filter to be used in the tallies
created to compute multi-group cross sections. At the present time, the
<code class="docutils literal"><span class="pre">Library</span></code> supports <code class="docutils literal"><span class="pre">&quot;material,&quot;</span></code> <code class="docutils literal"><span class="pre">&quot;cell,&quot;</span></code> and <code class="docutils literal"><span class="pre">&quot;universe&quot;</span></code>
domain types. We will use a <code class="docutils literal"><span class="pre">&quot;cell&quot;</span></code> domain type here to compute cross
sections in each of the cells in the fuel assembly geometry.</p>
<p><strong>Note:</strong> By default, the <code class="docutils literal"><span class="pre">Library</span></code> class will instantiate <code class="docutils literal"><span class="pre">MGXS</span></code>
objects for each and every domain (material, cell or universe) in the
geometry of interest. However, one may specify a subset of these domains
to the <code class="docutils literal"><span class="pre">Library.domains</span></code> property. In our case, we wish to compute
multi-group cross sections in each and every cell since they will be
needed in our downstream OpenMOC calculation on the identical
combinatorial geometry mesh.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Specify a &quot;cell&quot; domain type for the cross section tally filters</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">domain_type</span> <span class="o">=</span> <span class="s">&quot;cell&quot;</span>

<span class="c"># Specify the cell domains over which to compute multi-group cross sections</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">get_all_material_cells</span><span class="p">()</span>
</pre></div>
</div>
<p>We can easily instruct the <code class="docutils literal"><span class="pre">Library</span></code> to compute multi-group cross
sections on a nuclide-by-nuclide basis with the boolean
<code class="docutils literal"><span class="pre">Library.by_nuclide</span></code> property. By default, <code class="docutils literal"><span class="pre">by_nuclide</span></code> is set to
<code class="docutils literal"><span class="pre">False</span></code>, but we will set it to <code class="docutils literal"><span class="pre">True</span></code> here.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Compute cross sections on a nuclide-by-nuclide basis</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">by_nuclide</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
</div>
<p>Lastly, we use the <code class="docutils literal"><span class="pre">Library</span></code> to construct the tallies needed to
compute all of the requested multi-group cross sections in each domain
and nuclide.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Construct all tallies needed for the multi-group cross section library</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">build_library</span><span class="p">()</span>
</pre></div>
</div>
<p>The tallies can now be export to a &#8220;tallies.xml&#8221; input file for OpenMC.</p>
<p><strong>NOTE</strong>: At this point the <code class="docutils literal"><span class="pre">Library</span></code> has constructed nearly 100
distinct <code class="docutils literal"><span class="pre">Tally</span></code> objects. The overhead to tally in OpenMC scales as
<span class="math">\(O(N)\)</span> for <span class="math">\(N\)</span> tallies, which can become a bottleneck for
large tally datasets. To compensate for this, the Python API&#8217;s
<code class="docutils literal"><span class="pre">Tally</span></code>, <code class="docutils literal"><span class="pre">Filter</span></code> and <code class="docutils literal"><span class="pre">TalliesFile</span></code> classes allow for the smart
<em>merging</em> of tallies when possible. The <code class="docutils literal"><span class="pre">Library</span></code> class supports this
runtime optimization with the use of the optional <code class="docutils literal"><span class="pre">merge</span></code> paramter
(<code class="docutils literal"><span class="pre">False</span></code> by default) for the <code class="docutils literal"><span class="pre">Library.add_to_tallies_file(...)</span></code>
method, as shown below.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create a &quot;tallies.xml&quot; file for the MGXS Library</span>
<span class="n">tallies_file</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">TalliesFile</span><span class="p">()</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">add_to_tallies_file</span><span class="p">(</span><span class="n">tallies_file</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition, we instantiate a fission rate mesh tally to compare with
OpenMOC.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a tally Mesh</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Mesh</span><span class="p">(</span><span class="n">mesh_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&#39;regular&#39;</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">]</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">lower_left</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">10.71</span><span class="p">,</span> <span class="o">-</span><span class="mf">10.71</span><span class="p">]</span>
<span class="n">mesh</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.26</span><span class="p">,</span> <span class="mf">1.26</span><span class="p">]</span>

<span class="c"># Instantiate tally Filter</span>
<span class="n">mesh_filter</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Filter</span><span class="p">()</span>
<span class="n">mesh_filter</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">mesh</span>

<span class="c"># Instantiate the Tally</span>
<span class="n">tally</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;mesh tally&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="n">mesh_filter</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;fission&#39;</span><span class="p">)</span>
<span class="n">tally</span><span class="o">.</span><span class="n">add_score</span><span class="p">(</span><span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>

<span class="c"># Add mesh and Tally to TalliesFile</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">)</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">add_tally</span><span class="p">(</span><span class="n">tally</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Export all tallies to a &quot;tallies.xml&quot; file</span>
<span class="n">tallies_file</span><span class="o">.</span><span class="n">export_to_xml</span><span class="p">()</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Run OpenMC</span>
<span class="n">executor</span><span class="o">.</span><span class="n">run_simulation</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>       .d88888b.                             888b     d888  .d8888b.
      d88P&quot; &quot;Y88b                            8888b   d8888 d88P  Y88b
      888     888                            88888b.d88888 888    888
      888     888 88888b.   .d88b.  88888b.  888Y88888P888 888
      888     888 888 &quot;88b d8P  Y8b 888 &quot;88b 888 Y888P 888 888
      888     888 888  888 88888888 888  888 888  Y8P  888 888    888
      Y88b. .d88P 888 d88P Y8b.     888  888 888   &quot;   888 Y88b  d88P
       &quot;Y88888P&quot;  88888P&quot;   &quot;Y8888  888  888 888       888  &quot;Y8888P&quot;
__________________888______________________________________________________
                  888
                  888

      Copyright:      2011-2015 Massachusetts Institute of Technology
      License:        http://mit-crpg.github.io/openmc/license.html
      Version:        0.7.0
      Git SHA1:       c4b14a5ef87f004528d35cbf33fef3ed15a386ca
      Date/Time:      2015-11-30 21:20:07
      MPI Processes:  1

 ===========================================================================
 ========================&gt;     INITIALIZATION     &lt;=========================
 ===========================================================================

 Reading settings XML file...
 Reading cross sections XML file...
 Reading geometry XML file...
 Reading materials XML file...
 Reading tallies XML file...
 Building neighboring cells lists for each surface...
 Loading ACE cross section table: 92235.71c
 Loading ACE cross section table: 92238.71c
 Loading ACE cross section table: 8016.71c
 Loading ACE cross section table: 1001.71c
 Loading ACE cross section table: 5010.71c
 Loading ACE cross section table: 40090.71c
 Maximum neutron transport energy: 20.0000 MeV for 92235.71c
 Initializing source particles...

 ===========================================================================
 ====================&gt;     K EIGENVALUE SIMULATION     &lt;====================
 ===========================================================================

  Bat./Gen.      k            Average k
  =========   ========   ====================
        1/1    1.02650
        2/1    1.01386
        3/1    1.01045
        4/1    1.05511
        5/1    1.04873
        6/1    1.04558
        7/1    1.03840
        8/1    1.02086
        9/1    1.08845
       10/1    1.03932
       11/1    1.01271
       12/1    1.03448    1.02360 +/- 0.01088
       13/1    1.04395    1.03038 +/- 0.00925
       14/1    1.05477    1.03648 +/- 0.00894
       15/1    1.00485    1.03015 +/- 0.00938
       16/1    1.04523    1.03267 +/- 0.00806
       17/1    1.01328    1.02990 +/- 0.00735
       18/1    1.01476    1.02800 +/- 0.00664
       19/1    1.01490    1.02655 +/- 0.00604
       20/1    1.00926    1.02482 +/- 0.00567
       21/1    0.98504    1.02120 +/- 0.00627
       22/1    1.00397    1.01977 +/- 0.00591
       23/1    1.02556    1.02021 +/- 0.00545
       24/1    0.99808    1.01863 +/- 0.00529
       25/1    0.99638    1.01715 +/- 0.00514
       26/1    0.99615    1.01584 +/- 0.00499
       27/1    1.01843    1.01599 +/- 0.00469
       28/1    1.00315    1.01528 +/- 0.00447
       29/1    1.00633    1.01480 +/- 0.00426
       30/1    1.02159    1.01514 +/- 0.00405
       31/1    1.03395    1.01604 +/- 0.00396
       32/1    1.02672    1.01652 +/- 0.00381
       33/1    1.03778    1.01745 +/- 0.00375
       34/1    1.03807    1.01831 +/- 0.00369
       35/1    1.07854    1.02072 +/- 0.00428
       36/1    1.03524    1.02128 +/- 0.00415
       37/1    1.03100    1.02164 +/- 0.00401
       38/1    1.03853    1.02224 +/- 0.00391
       39/1    1.04089    1.02288 +/- 0.00383
       40/1    1.02150    1.02284 +/- 0.00370
       41/1    0.98470    1.02161 +/- 0.00379
       42/1    1.00658    1.02114 +/- 0.00370
       43/1    0.98652    1.02009 +/- 0.00373
       44/1    1.02787    1.02032 +/- 0.00363
       45/1    0.98800    1.01939 +/- 0.00364
       46/1    1.00286    1.01893 +/- 0.00357
       47/1    1.02559    1.01911 +/- 0.00348
       48/1    1.03729    1.01959 +/- 0.00342
       49/1    1.02538    1.01974 +/- 0.00333
       50/1    1.01478    1.01962 +/- 0.00325
 Creating state point statepoint.50.h5...

 ===========================================================================
 ======================&gt;     SIMULATION FINISHED     &lt;======================
 ===========================================================================


 =======================&gt;     TIMING STATISTICS     &lt;=======================

 Total time for initialization     =  4.2800E-01 seconds
   Reading cross sections          =  9.1000E-02 seconds
 Total time in simulation          =  4.1240E+01 seconds
   Time in transport only          =  4.1215E+01 seconds
   Time in inactive batches        =  4.0230E+00 seconds
   Time in active batches          =  3.7217E+01 seconds
   Time synchronizing fission bank =  8.0000E-03 seconds
     Sampling source sites         =  6.0000E-03 seconds
     SEND/RECV source sites        =  2.0000E-03 seconds
   Time accumulating tallies       =  2.0000E-03 seconds
 Total time for finalization       =  0.0000E+00 seconds
 Total time elapsed                =  4.1683E+01 seconds
 Calculation Rate (inactive)       =  6214.27 neutrons/second
 Calculation Rate (active)         =  2686.94 neutrons/second

 ============================&gt;     RESULTS     &lt;============================

 k-effective (Collision)     =  1.01805 +/-  0.00261
 k-effective (Track-length)  =  1.01962 +/-  0.00325
 k-effective (Absorption)    =  1.01554 +/-  0.00339
 Combined k-effective        =  1.01711 +/-  0.00235
 Leakage Fraction            =  0.00000 +/-  0.00000
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="tally-data-processing">
<h1>Tally Data Processing<a class="headerlink" href="#tally-data-processing" title="Permalink to this headline">¶</a></h1>
<p>Our simulation ran successfully and created statepoint and summary
output files. We begin our analysis by instantiating a <code class="docutils literal"><span class="pre">StatePoint</span></code>
object.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the last statepoint file</span>
<span class="n">sp</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">StatePoint</span><span class="p">(</span><span class="s">&#39;statepoint.50.h5&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In addition to the statepoint file, our simulation also created a
summary file which encapsulates information about the materials and
geometry. This is necessary for the <code class="docutils literal"><span class="pre">openmc.mgxs</span></code> module to properly
process the tally data. We first create a <code class="docutils literal"><span class="pre">Summary</span></code> object and link it
with the statepoint.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">su</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">Summary</span><span class="p">(</span><span class="s">&#39;summary.h5&#39;</span><span class="p">)</span>
<span class="n">sp</span><span class="o">.</span><span class="n">link_with_summary</span><span class="p">(</span><span class="n">su</span><span class="p">)</span>
</pre></div>
</div>
<p>The statepoint is now ready to be analyzed by the <code class="docutils literal"><span class="pre">Library</span></code>. We simply
have to load the tallies from the statepoint into the <code class="docutils literal"><span class="pre">Library</span></code> and
our <code class="docutils literal"><span class="pre">MGXS</span></code> objects will compute the cross sections for us
under-the-hood.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Initialize MGXS Library with OpenMC statepoint data</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">load_from_statepoint</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>/usr/local/lib/python2.7/dist-packages/openmc-0.7.0-py2.7.egg/openmc/tallies.py:1514: RuntimeWarning: invalid value encountered in true_divide
/usr/local/lib/python2.7/dist-packages/openmc-0.7.0-py2.7.egg/openmc/tallies.py:1515: RuntimeWarning: invalid value encountered in true_divide
/usr/local/lib/python2.7/dist-packages/openmc-0.7.0-py2.7.egg/openmc/tallies.py:1516: RuntimeWarning: invalid value encountered in true_divide
</pre></div>
</div>
<p>Voila! Our multi-group cross sections are now ready to rock &#8216;n roll!</p>
</div>
<div class="section" id="extracting-and-storing-mgxs-data">
<h1>Extracting and Storing MGXS Data<a class="headerlink" href="#extracting-and-storing-mgxs-data" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal"><span class="pre">Library</span></code> supports a rich API to automate a variety of tasks,
including multi-group cross section data retrieval and storage. We will
highlight a few of these features here. First, the
<code class="docutils literal"><span class="pre">Library.get_mgxs(...)</span></code> method allows one to extract an <code class="docutils literal"><span class="pre">MGXS</span></code>
object from the <code class="docutils literal"><span class="pre">Library</span></code> for a particular domain and cross section
type. The following cell illustrates how one may extract the
<code class="docutils literal"><span class="pre">NuFissionXS</span></code> object for the fuel cell.</p>
<p><strong>Note:</strong> The <code class="docutils literal"><span class="pre">MGXS.get_mgxs(...)</span></code> method will accept either the
domain <em>or</em> the integer domain ID of interest.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Retrieve the NuFissionXS object for the fuel cell from the library</span>
<span class="n">fuel_mgxs</span> <span class="o">=</span> <span class="n">mgxs_lib</span><span class="o">.</span><span class="n">get_mgxs</span><span class="p">(</span><span class="n">fuel_cell</span><span class="p">,</span> <span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">NuFissionXS</span></code> object supports all of the methods described
previously the <code class="docutils literal"><span class="pre">openmc.mgxs</span></code> tutorials, such as
<a class="reference external" href="http://pandas.pydata.org/">Pandas</a> <code class="docutils literal"><span class="pre">DataFrames</span></code>:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">df</span> <span class="o">=</span> <span class="n">fuel_mgxs</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
<span class="n">df</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>/usr/local/lib/python2.7/dist-packages/openmc-0.7.0-py2.7.egg/openmc/mgxs/mgxs.py:1254: FutureWarning: elementwise comparison failed; returning scalar instead, but in the future will perform elementwise comparison
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell</th>
      <th>group in</th>
      <th>nuclide</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3</th>
      <td>10000</td>
      <td>1</td>
      <td>U-235</td>
      <td>8.063513e-03</td>
      <td>4.062984e-05</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10000</td>
      <td>1</td>
      <td>U-238</td>
      <td>7.335515e-03</td>
      <td>4.459335e-05</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10000</td>
      <td>1</td>
      <td>O-16</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>0</th>
      <td>10000</td>
      <td>2</td>
      <td>U-235</td>
      <td>3.613274e-01</td>
      <td>1.902492e-03</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10000</td>
      <td>2</td>
      <td>U-238</td>
      <td>6.738424e-07</td>
      <td>3.536787e-09</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>2</td>
      <td>O-16</td>
      <td>0.000000e+00</td>
      <td>0.000000e+00</td>
    </tr>
  </tbody>
</table>
</div><p>Similarly, we can use the <code class="docutils literal"><span class="pre">MGXS.print_xs(...)</span></code> method to view a string
representation of the multi-group cross section data.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="n">fuel_mgxs</span><span class="o">.</span><span class="n">print_xs</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Multi-Group XS
    Reaction Type  =        nu-fission
    Domain Type    =        cell
    Domain ID      =        10000
    Nuclide        =        U-235
    Cross Sections [cm^-1]:
            Group 1 [6.25e-07   - 20.0      MeV]:   8.06e-03 +/- 5.04e-01%
            Group 2 [0.0        - 6.25e-07  MeV]:   3.61e-01 +/- 5.27e-01%

    Nuclide        =        U-238
    Cross Sections [cm^-1]:
            Group 1 [6.25e-07   - 20.0      MeV]:   7.34e-03 +/- 6.08e-01%
            Group 2 [0.0        - 6.25e-07  MeV]:   6.74e-07 +/- 5.25e-01%

    Nuclide        =        O-16
    Cross Sections [cm^-1]:
            Group 1 [6.25e-07   - 20.0      MeV]:   0.00e+00 +/- nan%
            Group 2 [0.0        - 6.25e-07  MeV]:   0.00e+00 +/- nan%
</pre></div>
</div>
<p>One can export the entire <code class="docutils literal"><span class="pre">Library</span></code> to HDF5 with the
<code class="docutils literal"><span class="pre">Library.build_hdf5_store(...)</span></code> method as follows:</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Store the cross section data in an &quot;mgxs/mgxs.h5&quot; HDF5 binary file</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">build_hdf5_store</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;mgxs.h5&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s">&#39;mgxs&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The HDF5 store will contain the numerical multi-group cross section data
indexed by domain, nuclide and cross section type. Some data workflows
may be optimized by storing and retrieving binary representations of the
<code class="docutils literal"><span class="pre">MGXS</span></code> objects in the <code class="docutils literal"><span class="pre">Library</span></code>. This feature is supported through
the <code class="docutils literal"><span class="pre">Library.dump_to_file(...)</span></code> and <code class="docutils literal"><span class="pre">Library.load_from_file(...)</span></code>
routines which use Python&#8217;s
<code class="docutils literal"><span class="pre">`pickle</span></code> &lt;<a class="reference external" href="https://docs.python.org/2/library/pickle.html">https://docs.python.org/2/library/pickle.html</a>&gt;`__ module.
This is illustrated as follows.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Store a Library and its MGXS objects in a pickled binary file &quot;mgxs/mgxs.pkl&quot;</span>
<span class="n">mgxs_lib</span><span class="o">.</span><span class="n">dump_to_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;mgxs&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s">&#39;mgxs&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Instantiate a new MGXS Library from the pickled binary file &quot;mgxs/mgxs.pkl&quot;</span>
<span class="n">mgxs_lib</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">mgxs</span><span class="o">.</span><span class="n">Library</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s">&#39;mgxs&#39;</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="s">&#39;mgxs&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">Library</span></code> class may be used to leverage the energy condensation
features supported by the <code class="docutils literal"><span class="pre">MGXS</span></code> class. In particular, one can use the
<code class="docutils literal"><span class="pre">Library.get_condensed_library(...)</span></code> with a coarse group structure
which is a subset of the original &#8220;fine&#8221; group structure as shown below.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create a 1-group structure</span>
<span class="n">coarse_groups</span> <span class="o">=</span> <span class="n">openmc</span><span class="o">.</span><span class="n">mgxs</span><span class="o">.</span><span class="n">EnergyGroups</span><span class="p">(</span><span class="n">group_edges</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">])</span>

<span class="c"># Create a new MGXS Library on the coarse 1-group structure</span>
<span class="n">coarse_mgxs_lib</span> <span class="o">=</span> <span class="n">mgxs_lib</span><span class="o">.</span><span class="n">get_condensed_library</span><span class="p">(</span><span class="n">coarse_groups</span><span class="p">)</span>
</pre></div>
</div>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Retrieve the NuFissionXS object for the fuel cell from the 1-group library</span>
<span class="n">coarse_fuel_mgxs</span> <span class="o">=</span> <span class="n">coarse_mgxs_lib</span><span class="o">.</span><span class="n">get_mgxs</span><span class="p">(</span><span class="n">fuel_cell</span><span class="p">,</span> <span class="s">&#39;nu-fission&#39;</span><span class="p">)</span>

<span class="c"># Show the Pandas DataFrame for the 1-group MGXS</span>
<span class="n">coarse_fuel_mgxs</span><span class="o">.</span><span class="n">get_pandas_dataframe</span><span class="p">()</span>
</pre></div>
</div>
<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell</th>
      <th>group in</th>
      <th>nuclide</th>
      <th>mean</th>
      <th>std. dev.</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10000</td>
      <td>1</td>
      <td>U-235</td>
      <td>0.074383</td>
      <td>0.000280</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10000</td>
      <td>1</td>
      <td>U-238</td>
      <td>0.005959</td>
      <td>0.000036</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10000</td>
      <td>1</td>
      <td>O-16</td>
      <td>0.000000</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
<div class="section" id="verification-with-openmoc">
<h1>Verification with OpenMOC<a class="headerlink" href="#verification-with-openmoc" title="Permalink to this headline">¶</a></h1>
<p>Of course it is always a good idea to verify that one&#8217;s cross sections
are accurate. We can easily do so here with the deterministic transport
code <a class="reference external" href="https://mit-crpg.github.io/OpenMOC/">OpenMOC</a>. We will extract
an OpenCG geometry from the summary file and convert it into an
equivalent OpenMOC geometry.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Create an OpenMOC Geometry from the OpenCG Geometry</span>
<span class="n">openmoc_geometry</span> <span class="o">=</span> <span class="n">get_openmoc_geometry</span><span class="p">(</span><span class="n">mgxs_lib</span><span class="o">.</span><span class="n">opencg_geometry</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we can inject the multi-group cross sections into the equivalent
fuel assembly OpenMOC geometry. The <code class="docutils literal"><span class="pre">openmoc.materialize</span></code> module
supports the loading of <code class="docutils literal"><span class="pre">Library</span></code> objects from OpenMC as illustrated
below.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Load the library into the OpenMOC geometry</span>
<span class="n">materials</span> <span class="o">=</span> <span class="n">load_openmc_mgxs_lib</span><span class="p">(</span><span class="n">mgxs_lib</span><span class="p">,</span> <span class="n">openmoc_geometry</span><span class="p">)</span>
</pre></div>
</div>
<p>We are now ready to run OpenMOC to verify our cross-sections from
OpenMC.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Generate tracks for OpenMOC</span>
<span class="n">openmoc_geometry</span><span class="o">.</span><span class="n">initializeFlatSourceRegions</span><span class="p">()</span>
<span class="n">track_generator</span> <span class="o">=</span> <span class="n">openmoc</span><span class="o">.</span><span class="n">TrackGenerator</span><span class="p">(</span><span class="n">openmoc_geometry</span><span class="p">,</span> <span class="n">num_azim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">track_generator</span><span class="o">.</span><span class="n">generateTracks</span><span class="p">()</span>

<span class="c"># Run OpenMOC</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">openmoc</span><span class="o">.</span><span class="n">CPUSolver</span><span class="p">(</span><span class="n">track_generator</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">computeEigenvalue</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>[  NORMAL ]  Ray tracing for track segmentation...
[  NORMAL ]  Dumping tracks to file...
[  NORMAL ]  Computing the eigenvalue...
[  NORMAL ]  Iteration 0:   k_eff = 0.854316        res = 0.000E+00
[  NORMAL ]  Iteration 1:   k_eff = 0.801593        res = 1.522E-01
[  NORMAL ]  Iteration 2:   k_eff = 0.761131        res = 6.380E-02
[  NORMAL ]  Iteration 3:   k_eff = 0.731467        res = 5.066E-02
[  NORMAL ]  Iteration 4:   k_eff = 0.709897        res = 3.910E-02
[  NORMAL ]  Iteration 5:   k_eff = 0.695110        res = 2.954E-02
[  NORMAL ]  Iteration 6:   k_eff = 0.685966        res = 2.085E-02
[  NORMAL ]  Iteration 7:   k_eff = 0.681511        res = 1.317E-02
[  NORMAL ]  Iteration 8:   k_eff = 0.680926        res = 6.520E-03
[  NORMAL ]  Iteration 9:   k_eff = 0.683509        res = 1.046E-03
[  NORMAL ]  Iteration 10:  k_eff = 0.688659        res = 3.848E-03
[  NORMAL ]  Iteration 11:  k_eff = 0.695860        res = 7.565E-03
[  NORMAL ]  Iteration 12:  k_eff = 0.704674        res = 1.048E-02
[  NORMAL ]  Iteration 13:  k_eff = 0.714726        res = 1.269E-02
[  NORMAL ]  Iteration 14:  k_eff = 0.725700        res = 1.428E-02
[  NORMAL ]  Iteration 15:  k_eff = 0.737329        res = 1.537E-02
[  NORMAL ]  Iteration 16:  k_eff = 0.749388        res = 1.604E-02
[  NORMAL ]  Iteration 17:  k_eff = 0.761690        res = 1.637E-02
[  NORMAL ]  Iteration 18:  k_eff = 0.774081        res = 1.643E-02
[  NORMAL ]  Iteration 19:  k_eff = 0.786432        res = 1.628E-02
[  NORMAL ]  Iteration 20:  k_eff = 0.798638        res = 1.597E-02
[  NORMAL ]  Iteration 21:  k_eff = 0.810618        res = 1.553E-02
[  NORMAL ]  Iteration 22:  k_eff = 0.822303        res = 1.501E-02
[  NORMAL ]  Iteration 23:  k_eff = 0.833643        res = 1.443E-02
[  NORMAL ]  Iteration 24:  k_eff = 0.844598        res = 1.380E-02
[  NORMAL ]  Iteration 25:  k_eff = 0.855140        res = 1.315E-02
[  NORMAL ]  Iteration 26:  k_eff = 0.865249        res = 1.249E-02
[  NORMAL ]  Iteration 27:  k_eff = 0.874914        res = 1.183E-02
[  NORMAL ]  Iteration 28:  k_eff = 0.884128        res = 1.118E-02
[  NORMAL ]  Iteration 29:  k_eff = 0.892891        res = 1.054E-02
[  NORMAL ]  Iteration 30:  k_eff = 0.901206        res = 9.920E-03
[  NORMAL ]  Iteration 31:  k_eff = 0.909080        res = 9.320E-03
[  NORMAL ]  Iteration 32:  k_eff = 0.916523        res = 8.745E-03
[  NORMAL ]  Iteration 33:  k_eff = 0.923546        res = 8.194E-03
[  NORMAL ]  Iteration 34:  k_eff = 0.930162        res = 7.669E-03
[  NORMAL ]  Iteration 35:  k_eff = 0.936387        res = 7.171E-03
[  NORMAL ]  Iteration 36:  k_eff = 0.942236        res = 6.698E-03
[  NORMAL ]  Iteration 37:  k_eff = 0.947725        res = 6.252E-03
[  NORMAL ]  Iteration 38:  k_eff = 0.952869        res = 5.830E-03
[  NORMAL ]  Iteration 39:  k_eff = 0.957687        res = 5.433E-03
[  NORMAL ]  Iteration 40:  k_eff = 0.962193        res = 5.060E-03
[  NORMAL ]  Iteration 41:  k_eff = 0.966404        res = 4.710E-03
[  NORMAL ]  Iteration 42:  k_eff = 0.970337        res = 4.381E-03
[  NORMAL ]  Iteration 43:  k_eff = 0.974006        res = 4.073E-03
[  NORMAL ]  Iteration 44:  k_eff = 0.977426        res = 3.785E-03
[  NORMAL ]  Iteration 45:  k_eff = 0.980613        res = 3.515E-03
[  NORMAL ]  Iteration 46:  k_eff = 0.983580        res = 3.264E-03
[  NORMAL ]  Iteration 47:  k_eff = 0.986341        res = 3.029E-03
[  NORMAL ]  Iteration 48:  k_eff = 0.988908        res = 2.809E-03
[  NORMAL ]  Iteration 49:  k_eff = 0.991293        res = 2.605E-03
[  NORMAL ]  Iteration 50:  k_eff = 0.993509        res = 2.415E-03
[  NORMAL ]  Iteration 51:  k_eff = 0.995566        res = 2.238E-03
[  NORMAL ]  Iteration 52:  k_eff = 0.997475        res = 2.073E-03
[  NORMAL ]  Iteration 53:  k_eff = 0.999246        res = 1.920E-03
[  NORMAL ]  Iteration 54:  k_eff = 1.000888        res = 1.777E-03
[  NORMAL ]  Iteration 55:  k_eff = 1.002409        res = 1.645E-03
[  NORMAL ]  Iteration 56:  k_eff = 1.003818        res = 1.522E-03
[  NORMAL ]  Iteration 57:  k_eff = 1.005123        res = 1.408E-03
[  NORMAL ]  Iteration 58:  k_eff = 1.006331        res = 1.302E-03
[  NORMAL ]  Iteration 59:  k_eff = 1.007450        res = 1.203E-03
[  NORMAL ]  Iteration 60:  k_eff = 1.008484        res = 1.112E-03
[  NORMAL ]  Iteration 61:  k_eff = 1.009440        res = 1.028E-03
[  NORMAL ]  Iteration 62:  k_eff = 1.010324        res = 9.496E-04
[  NORMAL ]  Iteration 63:  k_eff = 1.011141        res = 8.771E-04
[  NORMAL ]  Iteration 64:  k_eff = 1.011897        res = 8.100E-04
[  NORMAL ]  Iteration 65:  k_eff = 1.012594        res = 7.478E-04
[  NORMAL ]  Iteration 66:  k_eff = 1.013238        res = 6.903E-04
[  NORMAL ]  Iteration 67:  k_eff = 1.013833        res = 6.371E-04
[  NORMAL ]  Iteration 68:  k_eff = 1.014382        res = 5.879E-04
[  NORMAL ]  Iteration 69:  k_eff = 1.014889        res = 5.424E-04
[  NORMAL ]  Iteration 70:  k_eff = 1.015357        res = 5.004E-04
[  NORMAL ]  Iteration 71:  k_eff = 1.015789        res = 4.615E-04
[  NORMAL ]  Iteration 72:  k_eff = 1.016187        res = 4.255E-04
[  NORMAL ]  Iteration 73:  k_eff = 1.016554        res = 3.923E-04
[  NORMAL ]  Iteration 74:  k_eff = 1.016892        res = 3.617E-04
[  NORMAL ]  Iteration 75:  k_eff = 1.017204        res = 3.333E-04
[  NORMAL ]  Iteration 76:  k_eff = 1.017492        res = 3.072E-04
[  NORMAL ]  Iteration 77:  k_eff = 1.017757        res = 2.831E-04
[  NORMAL ]  Iteration 78:  k_eff = 1.018001        res = 2.608E-04
[  NORMAL ]  Iteration 79:  k_eff = 1.018226        res = 2.403E-04
[  NORMAL ]  Iteration 80:  k_eff = 1.018433        res = 2.213E-04
[  NORMAL ]  Iteration 81:  k_eff = 1.018624        res = 2.038E-04
[  NORMAL ]  Iteration 82:  k_eff = 1.018800        res = 1.877E-04
[  NORMAL ]  Iteration 83:  k_eff = 1.018962        res = 1.728E-04
[  NORMAL ]  Iteration 84:  k_eff = 1.019110        res = 1.591E-04
[  NORMAL ]  Iteration 85:  k_eff = 1.019248        res = 1.465E-04
[  NORMAL ]  Iteration 86:  k_eff = 1.019374        res = 1.348E-04
[  NORMAL ]  Iteration 87:  k_eff = 1.019490        res = 1.241E-04
[  NORMAL ]  Iteration 88:  k_eff = 1.019597        res = 1.142E-04
[  NORMAL ]  Iteration 89:  k_eff = 1.019695        res = 1.051E-04
[  NORMAL ]  Iteration 90:  k_eff = 1.019786        res = 9.670E-05
[  NORMAL ]  Iteration 91:  k_eff = 1.019869        res = 8.895E-05
[  NORMAL ]  Iteration 92:  k_eff = 1.019946        res = 8.183E-05
[  NORMAL ]  Iteration 93:  k_eff = 1.020016        res = 7.528E-05
[  NORMAL ]  Iteration 94:  k_eff = 1.020081        res = 6.922E-05
[  NORMAL ]  Iteration 95:  k_eff = 1.020141        res = 6.368E-05
[  NORMAL ]  Iteration 96:  k_eff = 1.020195        res = 5.857E-05
[  NORMAL ]  Iteration 97:  k_eff = 1.020246        res = 5.385E-05
[  NORMAL ]  Iteration 98:  k_eff = 1.020292        res = 4.954E-05
[  NORMAL ]  Iteration 99:  k_eff = 1.020335        res = 4.553E-05
[  NORMAL ]  Iteration 100: k_eff = 1.020374        res = 4.185E-05
[  NORMAL ]  Iteration 101: k_eff = 1.020410        res = 3.848E-05
[  NORMAL ]  Iteration 102: k_eff = 1.020443        res = 3.537E-05
[  NORMAL ]  Iteration 103: k_eff = 1.020474        res = 3.253E-05
[  NORMAL ]  Iteration 104: k_eff = 1.020502        res = 2.989E-05
[  NORMAL ]  Iteration 105: k_eff = 1.020527        res = 2.746E-05
[  NORMAL ]  Iteration 106: k_eff = 1.020551        res = 2.526E-05
[  NORMAL ]  Iteration 107: k_eff = 1.020573        res = 2.319E-05
[  NORMAL ]  Iteration 108: k_eff = 1.020593        res = 2.134E-05
[  NORMAL ]  Iteration 109: k_eff = 1.020611        res = 1.960E-05
[  NORMAL ]  Iteration 110: k_eff = 1.020628        res = 1.800E-05
[  NORMAL ]  Iteration 111: k_eff = 1.020643        res = 1.652E-05
[  NORMAL ]  Iteration 112: k_eff = 1.020657        res = 1.518E-05
[  NORMAL ]  Iteration 113: k_eff = 1.020670        res = 1.398E-05
[  NORMAL ]  Iteration 114: k_eff = 1.020682        res = 1.283E-05
[  NORMAL ]  Iteration 115: k_eff = 1.020693        res = 1.178E-05
[  NORMAL ]  Iteration 116: k_eff = 1.020704        res = 1.083E-05
</pre></div>
</div>
<p>We report the eigenvalues computed by OpenMC and OpenMOC here together
to summarize our results.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Print report of keff and bias with OpenMC</span>
<span class="n">openmoc_keff</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">getKeff</span><span class="p">()</span>
<span class="n">openmc_keff</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">k_combined</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">openmoc_keff</span> <span class="o">-</span> <span class="n">openmc_keff</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e5</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;openmc keff = {0:1.6f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">openmc_keff</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;openmoc keff = {0:1.6f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">openmoc_keff</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;bias [pcm]: {0:1.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bias</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>openmc keff = 1.017105
openmoc keff = 1.020704
bias [pcm]: 359.8
</pre></div>
</div>
<p>There is a non-trivial bias between the eigenvalues computed by OpenMC
and OpenMOC. One can show that these biases do not converge to &lt;100 pcm
with more particle histories. For heterogeneous geometries, additional
measures must be taken to address the following three sources of bias:</p>
<ul class="simple">
<li>Appropriate transport-corrected cross sections</li>
<li>Spatial discretization of OpenMOC&#8217;s mesh</li>
<li>Constant-in-angle multi-group cross sections</li>
</ul>
</div>
<div class="section" id="flux-and-pin-power-visualizations">
<h1>Flux and Pin Power Visualizations<a class="headerlink" href="#flux-and-pin-power-visualizations" title="Permalink to this headline">¶</a></h1>
<p>We will conclude this tutorial by illustrating how to visualize the
fission rates computed by OpenMOC and OpenMC. First, we extract
volume-integrated fission rates from OpenMC&#8217;s mesh fission rate tally
for each pin cell in the fuel assembly.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Get the OpenMC fission rate mesh tally data</span>
<span class="n">mesh_tally</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_tally</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;mesh tally&#39;</span><span class="p">)</span>
<span class="n">openmc_fission_rates</span> <span class="o">=</span> <span class="n">mesh_tally</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nu-fission&#39;</span><span class="p">])</span>

<span class="c"># Reshape array to 2D for plotting</span>
<span class="n">openmc_fission_rates</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">17</span><span class="p">)</span>

<span class="c"># Normalize to the average pin power</span>
<span class="n">openmc_fission_rates</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">openmc_fission_rates</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we extract OpenMOC&#8217;s volume-averaged fission rates into a 2D 17x17
NumPy array.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Export OpenMOC&#39;s fission rates for each pin cell instance in the fuel assembly</span>
<span class="n">openmoc</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">compute_fission_rates</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>

<span class="c"># Open the pickle file with the fission rates</span>
<span class="n">fission_rates</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;fission-rates/fission-rates.pkl&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span> <span class="p">))</span>

<span class="c"># Allocate array for fission rates in each fuel pin</span>
<span class="n">openmoc_fission_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">))</span>

<span class="c"># Extract fission rates for each fuel pin</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fission_rates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">lat_x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">lat_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">4</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">openmoc_fission_rates</span><span class="p">[</span><span class="n">lat_x</span><span class="p">,</span> <span class="n">lat_y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

<span class="c"># Normalize to the average pin fission rate</span>
<span class="n">openmoc_fission_rates</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">openmoc_fission_rates</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can easily use Matplotlib to visualize the fission rates from
OpenMC and OpenMOC side-by-side.</p>
<div class="code python highlight-python"><div class="highlight"><pre><span class="c"># Plot OpenMC&#39;s fission rates in the left subplot</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">openmc_fission_rates</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;OpenMC Fission Rates&#39;</span><span class="p">)</span>

<span class="c"># Plot OpenMOC&#39;s fission rates in the right subplot</span>
<span class="n">fig2</span> <span class="o">=</span> <span class="n">pylab</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">openmoc_fission_rates</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">&#39;jet&#39;</span><span class="p">)</span>
<span class="n">pylab</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;OpenMOC Fission Rates&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>&lt;matplotlib.text.Text at 0x7fb9acb6fc10&gt;
</pre></div>
</div>
<img alt="../../_images/mgxs-part-iii-content_90_1.png" src="../../_images/mgxs-part-iii-content_90_1.png" />
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>


    <div class="footer" role="contentinfo">
        &copy; Copyright 2011-2015, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.3.
    </div>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

  </body>
</html>